# Журнал проекта

## 2026-02-13
- В `updater.sh` добавлено слияние `config.py`: скрипт сохраняет текущие значения и автоматически дописывает недостающие параметры из свежего шаблона репозитория.
- Добавлена переменная `MERGE_CONFIG_DEFAULTS` (`1` по умолчанию, `0` для отключения автодобавления параметров).
- Обновлена документация (`README.md`, `docs/PROJECT_DOC_RU.md`) по новому поведению обновления конфигурации.

## 2026-02-09
- `/map_install` расширен для архивов с ресурсами: поддержаны структурные ZIP (`maps/models/sound/sprites/gfx/overviews/resource`) и плоские ZIP с раскладкой по расширению.
- Добавлена строгая проверка путей в архиве: блокируются абсолютные пути, `..` и конфликтующие целевые дубликаты.
- FTP-пайплайн переведён на multi-file upload с политикой `skip existing + warning` (без перезаписи существующих файлов на сервере).
- При частичной ошибке загрузки откат не выполняется: уже загруженные файлы сохраняются, в ответ команды возвращается детальный отчёт по uploaded/skipped/rejected.
- Добавление карты в ротацию при `add_to_rotation=true` теперь выполняется только при «чистой» установке (без skipped/rejected и с успешной загрузкой `.bsp`).
- Обновлены `/help`, `README.md`, `docs/PROJECT_DOC_RU.md`, `docs/COMMANDS_REFERENCE_RU.md` и `config.py` под новую схему `MAP_REMOTE_*`.

## 2026-02-08
- Добавлены команды `/server_maps` и `/server_maps_installed` для явного чтения карт именно с игрового сервера (активная ротация vs установленные `.bsp` в `maps/`) с пагинацией `page/per_page`.
- В AMX-плагин добавлена RCON-команда `ultrahc_ds_get_maps <rotation|installed>` с машинно-читаемыми маркерами ответа `ULTRAHC_MAPS_BEGIN/END` для стабильного парсинга ботом.
- Проведена полная актуализация пользовательской документации (`README.md`, `docs/PROJECT_DOC_RU.md`, `docs/COMMANDS_REFERENCE_RU.md`) под новый production-флоу `/map_install` (FTP/FTPS, фоновые операции, опциональная ротация, обязательные параметры `config.py`).
- Переведён `/map_install` из тестового режима в прод-пайплайн: загрузка из Discord, валидация `.bsp/.zip`, доставка в `maps/` через FTP/FTPS.
- Добавлен режим `sync + timeout -> background`: при долгой установке команда отвечает сразу и завершает операцию фоново с отдельным итоговым сообщением.
- Для `/map_install` добавлены параметры `add_to_rotation` и `priority`; ротация выполняется опционально.
- Реализованы внутренние маршруты `/db/map_exists`, `/db/map_add_internal`, `/cs/reload_map_list` для безопасной интеграции deploy-пайплайна с БД/Redis/CS.
- Найдена и исправлена причина обрезки Discord → CS сообщений на 5-8 слове: в `HookMsgFromDs` аргументы команды `ultrahc_ds_send_msg` читались буфером 64 символа.
- В `amxmodx_plugin/ultrahc_discord.sma` увеличены буферы чтения и парсинга (`cmd_text` до 256, `msg` до 192), поэтому короткие и средние сообщения больше не обрываются на первых словах.
- Проведено исследование деградации status-канала: узкое место в pull-схеме `status_task -> RCON ultrahc_ds_get_info -> webhook info`, из-за которой обновления могли «замирать» при долгой нестабильности цепочки.
- Переведено обновление статуса на push-модель: AMX-плагин отправляет `type=info` по событиям (`client_putinserver`, `client_disconnected`, `DeathMsg`, `TeamInfo`) и по heartbeat-таймеру (30 сек).
- Постоянный polling статуса из `bot/events.py` отключён; RCON оставлен для управляющих команд из Discord.
- В Python-слое удалены неиспользуемые сущности старого polling-механизма (`status_task`, `BT_CS_Status`, `fetch_status`), чтобы снизить сложность поддержки.
- Для webhook payload в AMX-плагине увеличен JSON-буфер до 4096, добавлено экранирование спецсимволов (`\`, `"`) и исправлено формирование списка игроков (разделители без ошибок при пропусках), чтобы снизить риск невалидного JSON при онлайне.

## 2025-12-13
- Усилена устойчивость обновления статуса CS: если webhook info не пришёл вовремя, бот переподключается автоматически.
- Добавлена переменная конфигурации CS_INFO_WEBHOOK_TIMEOUT.
- Улучшено логирование исключений в observer и восстановление фоновых задач.

## 2024-05-19
- Добавлены скрипты `updater.sh` и `restore.sh` для обновления и восстановления файлов бота.
- Создана русскоязычная документация и введён рабочий журнал.
- Настроены инструкции для дальнейших изменений в `AGENTS.md`.
- Реализована команда `/map_install` для загрузки файлов карт через Discord и создания тестовых параметров.
- Добавлен обработчик, сохраняющий вложения в `uploaded_maps/` и формирующий текстовые файлы с min/max игроками.
- Обновлена документация с описанием новой команды.
- Исправлено событие подключения в команде `/connect_to_cs`, чтобы после успешного подключения запускалось обновление статуса.

## 2024-05-21
- Логгер автоматически создаёт директорию `logs`, предотвращая сбои после обновления проекта.

## 2025-10-01
- Исправлено форматирование сообщения `logger.info` в установщике карт, чтобы команда `/map_install` завершала взаимодействие корректным ответом.

## 2025-10-02
- Реализована команда `/help`, выводящая описание всех доступных команд с пометкой тестовых функций.
- Дополнены инструкции `AGENTS.md` требованием поддерживать команду `/help` в актуальном состоянии.
- Обновлена документация: добавлено описание `/help`, команда `/map_install` отмечена как тестовая.

## 2025-10-03
- Подготовлен подробный справочник `docs/COMMANDS_REFERENCE_RU.md` с описанием всех команд и примерами использования.
- Команда `/help` дополнена ссылкой на GitHub-версию справочника для получения расширенной информации.
- Обновлены инструкции для агентов, README и основная документация с ссылками на новый справочник.

## 2025-10-04
- При запуске бот отправляет уведомление в администраторский канал с напоминанием о команде `/help`.
- В `config.py` возвращён параметр `ADMIN_CHANNEL_ID` с возможностью отключить уведомления.
- Обновлена документация (README и `docs/PROJECT_DOC_RU.md`) по настройке уведомлений.

## 2025-10-05
- Команды в `/help` и стартовом сообщении выводятся в формате упоминаний Discord, что позволяет вставлять их кликом.
- Добавлен вспомогательный метод для получения `mention`-представления команд.
- Исправлена ошибка импорта при запуске: использование модуля `utilities` больше не конфликтует с экземпляром бота.

## 2025-10-06
- Исправлена ошибка запуска `/help`: при недоступности `mention` команда теперь отображается текстовым вариантом `/команда` без падения бота.


## 2025-10-07
- Обновлена подготовка аргументов RCON: двойные кавычки заменяются на одинарные, а обратные слэши дублируются перед отправкой, чтобы команды с особыми символами не ломались в HLDS.
- Модульный тест `tests/test_cs_server_escape.py` расширен кейсами для замены кавычек и дублирования обратных слэшей.
- Документация описывает замену двойных кавычек на одинарные и дублирование обратных слэшей в параметрах RCON.
- Плагин AMX Mod X продолжает разворачивать переданные обратные слэши, поэтому пути и причины отображаются без искажений.
- В плагине AMX Mod X удалён вспомогательный метод разворачивания параметров RCON; команды снова получают аргументы без дополнительной обработки, что откатывает поведение к изначальному виду.

## 2025-12-14
- Исправлена регрессия: при неудачном подключении к CS серверу событие `CS_DISCONNECTED` отправлялось дважды, что приводило к двойной обработке подписчиками.
- Добавлена сериализация операций RCON (connect/exec), чтобы исключить гонки при параллельных попытках подключения.
- Усилен парсинг RCON `getchallenge` и ответов команд для лучшей совместимости с HLDS/ReHLDS.
- Добавлен параметр `CS_CONNECT_MIN_INTERVAL`, чтобы избежать дублей попыток подключения при старте.
- Логирование запросов с неразрешённых IP сделано безопаснее: без чтения/вывода тела запроса в лог.
- Добавлена ежедневная ротация логов: текущий день всегда в `logs/log.txt`, хранение 7 дней.
- `logger.info/error` теперь поддерживает форматирование с аргументами (как стандартный `logging`), исправлено падение обработчика `WS_IP_NOT_ALLOWED`.
- Webhook `/webhook`: если `API_KEY` не задан, проверка ключа отключена; при ошибке авторизации пишется расширенный лог без тела запроса.
- Добавлен параметр `CS_INFO_WEBHOOK_MAX_MISSES`: переподключение выполняется только после нескольких пропусков webhook `type=info` подряд.

- Событие CS_DISCONNECTED теперь отправляется один раз за цикл подключения, чтобы подписчики не срабатывали дважды.
- RCON-ответы для ultrahc_ds_get_info и ultrahc_ds_send_msg проверяются на Unknown command/Bad rcon_password; при ошибке связь помечается разорванной и запускается переподключение.

- RCON: откатил парсинг пакетов к стабильной версии до 14.12, чтобы восстановить handshake и команды из Discord → CS.
- Статус CS теперь вызывается одноразовым RCON-подключением на каждый цикл; таймауты отсутствия webhook лишь логируются, отключение происходит только при реальных ошибках RCON (bad password/unknown command/оффлайн).
