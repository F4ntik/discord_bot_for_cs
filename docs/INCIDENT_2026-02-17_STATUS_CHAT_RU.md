# Инцидент 2026-02-17: status/info webhook ломал Discord -> CS чат

## Краткое резюме
- Проблема проявлялась только при включенном `type=info` и живом онлайне (игрок/HLTV/боты).
- Канал CS -> Discord работал, а Discord -> CS (`ultrahc_ds_send_msg`) периодически «замолкал».
- На раннем этапе также были ошибки `400 unknown_type` и `500 Internal Server Error` по `/webhook`.

## Симптомы
- В логах бота:
  - `Webhook unknown type: type= nfo` / `type=in o`
  - позже `AttributeError: 'Log' object has no attribute 'warning'`
- В консоли CS:
  - `Response data: Bad Request` / `500 Internal Server Error`
  - RCON-команда `ultrahc_ds_send_msg` приходила, но чат не печатался при подключенных клиентах.

## Что было корнем проблемы
1. Бот падал на `logger.warning(...)` в webhook-обработчике из-за отсутствующего метода в обертке логгера.
2. Поле `type` в части info payload приходило «грязным» (` nfo`, `in o`), из-за чего бот отвечал `unknown_type`.
3. Новый AMX-обработчик Discord -> CS использовал `server_cmd("say ...") + server_exec()`, что при нагруженном игровом тике давало нестабильное поведение.
4. Сборка info JSON в AMX требовала усиления по буферам/ограничениям (иначе риск поврежденного payload на онлайне).

## Что сделали
### На стороне бота
- Добавили `warning` в логгер.
- Нормализовали `type` и добавили fallback через `type_code` (`1=info`, `2=message`).
- Усилили валидацию webhook payload.
- Добавили обработку `player_count` из info payload для статуса.

### На стороне AMX
- Оставили стабильный путь печати Discord -> CS через `client_print_color`.
- Убрали `server_exec()` из боевого пути.
- Усилили сборку info JSON:
  - увеличен dynamic heap (`#pragma dynamic 32768`);
  - вынесены рабочие буферы в глобальную область;
  - контроль переполнения/транкации при сборке списка игроков;
  - heartbeat + анти-спам (`inflight`/`rate`) сохранены.

## Финальный рабочий результат
- `type=info` стабильно обновляет статус (карта, онлайн, список игроков, команды, фраги/смерти).
- Discord -> CS чат снова стабилен при любом онлайне.
- Временные диагностические команды и debug-роуты удалены из боевой версии плагина.

## Итоговая версия AMX после зачистки
- `PLUGIN_VERSION`: `0.3-stable-20260217-1`
- Оставлен единый боевой обработчик: `ultrahc_ds_send_msg -> HookMsgFromDs`
- В сборке отсутствуют предупреждения компилятора.

## Проверка после деплоя
1. Проверить, что статус в Discord обновляет карту, онлайн и игроков.
2. Отправить 5-10 сообщений из Discord в CS при 0/1/N игроках.
3. Проверить, что в логах нет `unknown_type`, `500`, `HookMsgFromDs empty parsed values`.
