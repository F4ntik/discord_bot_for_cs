# Полный справочник команд Discord Bot for CS 1.6

Документ описывает все slash-команды, доступные в боте, их параметры, требования к правам и примеры использования. Актуальная информация по состоянию репозитория хранится в ветке `main`. При добавлении или изменении команд обновляйте этот файл и текст команды `/help`.

## Быстрый обзор команд

| Команда | Категория | Требуемые права | Назначение |
| --- | --- | --- | --- |
| `/help` | Общие | Не требуются | Показывает краткое описание команд и ссылку на этот справочник. |
| `/reg` | Общие | Не требуются | Привязывает Steam ID к Discord-пользователю. |
| `/unreg` | Общие | Не требуются | Удаляет привязку Steam ID. |
| `/clear` | Модерация Discord | `manage_messages` | Массовое удаление сообщений в канале. |
| `/connect_to_cs` | Администрирование CS | `manage_messages` | Устанавливает связь с игровым сервером. |
| `/rcon` | Администрирование CS | `manage_messages` | Выполняет произвольную RCON-команду. |
| `/kick` | Администрирование CS | `manage_messages` | Инициирует кик игрока. |
| `/ban` | Администрирование CS | `manage_messages` | Выдаёт бан активному игроку. |
| `/ban_offline` | Администрирование CS | `manage_messages` | Выдаёт бан игроку, покинувшему сервер. |
| `/unban` | Администрирование CS | `manage_messages` | Снимает бан по Steam ID. |
| `/sync_maps` | Администрирование CS | `manage_messages` | Синхронизирует базы карт между сервисами. |
| `/server_maps` | Администрирование CS | `manage_messages` | Показывает активную ротацию карт с CS-сервера через webhook snapshot. |
| `/server_maps_installed` | Администрирование CS | `manage_messages` | Показывает установленные `.bsp` карты из папки `maps/` через webhook snapshot. |
| `/map_change` | Администрирование CS | `manage_messages` | Сменяет текущую карту сервера. |
| `/map_install` | Администрирование CS | `manage_messages` | Загружает карту/архив ресурсов, отправляет на FTP/FTPS и опционально добавляет в ротацию. |
| `/map_add` | Администрирование CS | `manage_messages` | Добавляет карту в базу данных. |
| `/map_delete` | Администрирование CS | `manage_messages` | Удаляет карту из базы данных. |
| `/map_update` | Администрирование CS | `manage_messages` | Обновляет параметры карты. |

## Общие команды

### `/help`
- **Назначение:** вывод краткого списка доступных команд с разбивкой по категориям.
- **Права:** не требуются.
- **Результат:** отправляет эфемерное сообщение с перечнем команд по категориям и ссылкой на расширенную документацию.
- **Пример:** `/help`

### `/reg <steam_id>`
- **Назначение:** привязка Steam ID к текущему Discord-пользователю.
- **Права:** не требуются.
- **Параметры:**
  - `steam_id` — строка формата `STEAM_X:Y:Z`, UID Steam или другой идентификатор, поддерживаемый backend-ом.
- **Поведение:** взаимодействие обрабатывается асинхронно; пользователь получает уведомление о результате в личных сообщениях/ответе.
- **Пример:** `/reg STEAM_0:1:123456`

### `/unreg`
- **Назначение:** удаляет запись о пользователе из базы данных бота.
- **Права:** не требуются.
- **Параметры:** отсутствуют.
- **Поведение:** бот инициирует запрос в observer-сервис и подтверждает удаление в ответном сообщении.
- **Пример:** `/unreg`

## Команды модерации Discord

### `/clear <amount>`
- **Назначение:** массовое удаление сообщений в текущем канале.
- **Права:** `manage_messages`.
- **Параметры:**
  - `amount` — количество последних сообщений для удаления (включая команды бота).
- **Поведение:** бот удаляет запрошенное количество сообщений и сообщает, сколько сообщений было очищено.
- **Пример:** `/clear 50`

## Команды администрирования CS 1.6

### `/connect_to_cs`
- **Назначение:** инициирует подключение бота к игровому серверу и обновление статуса.
- **Права:** `manage_messages`.
- **Параметры:** отсутствуют.
- **Поведение:** принудительно переподключает бота к CS-серверу и (при успехе) перезапускает обновление статуса. Обычно не требуется, так как бот пытается переподключаться автоматически.
- **Пример:** `/connect_to_cs`

### `/rcon <command>`
- **Назначение:** выполняет переданную RCON-команду на игровом сервере.
- **Права:** `manage_messages`.
- **Параметры:**
  - `command` — строка с полной RCON-командой.
- **Поведение:** бот отправляет команду на сервер; ответ (если он предусмотрен) пересылается пользователю.
- **Пример:** `/rcon status`

### `/kick <target> [reason]`
- **Назначение:** кик игрока с сервера по нику или Steam ID.
- **Права:** `manage_messages`.
- **Параметры:**
  - `target` — ник или Steam ID. Поддерживается автодополнение текущих игроков.
  - `reason` — необязательное текстовое пояснение.
- **Поведение:** бот инициирует кик через observer-сервис и сообщает результат. При указании причины она логируется.
- **Пример:** `/kick PlayerOne Спамит в чат`

### `/ban <target> <minutes> [reason]`
- **Назначение:** выдаёт временный или перманентный бан активному игроку.
- **Права:** `manage_messages`.
- **Параметры:**
  - `target` — ник или Steam ID (автодополнение активных игроков).
  - `minutes` — длительность бана; `0` означает перманентный бан.
  - `reason` — необязательное пояснение, отображается в логах и сообщениях сервера.
- **Примеры:**
  - `/ban PlayerTwo 30 Flood` — бан на 30 минут за флуд.
  - `/ban STEAM_0:0:111111 0 Читы` — перманентный бан по Steam ID.

### `/ban_offline <steam_id> <minutes> [reason]`
- **Назначение:** выдаёт бан игроку, который не находится на сервере, но ранее был замечен.
- **Права:** `manage_messages`.
- **Параметры:**
  - `steam_id` — идентификатор игрока из базы.
  - `minutes` — длительность бана; `0` — перманентно.
  - `reason` — необязательный текст.
- **Пример:** `/ban_offline STEAM_0:1:999999 1440 Макросы`

### `/unban <steam_id>`
- **Назначение:** снимает ранее выданный бан.
- **Права:** `manage_messages`.
- **Параметры:**
  - `steam_id` — идентификатор игрока (автодополнение доступно для актуальных записей).
- **Поведение:** бот отправляет запрос в базу и уведомляет о результате.
- **Пример:** `/unban STEAM_0:1:999999`

### `/sync_maps`
- **Назначение:** синхронизирует списки карт между MySQL, Redis и файловой системой сервера.
- **Права:** `manage_messages`.
- **Параметры:** отсутствуют.
- **Поведение:** бот инициирует процедуру синхронизации; прогресс и результат фиксируются в логах.
- **Пример:** `/sync_maps`

### `/server_maps [page] [per_page]`
- **Назначение:** получить активную ротацию карт с игрового сервера (источник: серверный `maps_ultrahc.ini`/map manager).
- **Права:** `manage_messages`.
- **Параметры:**
  - `page` — номер страницы (по умолчанию `1`).
  - `per_page` — количество карт на странице (по умолчанию `20`, диапазон `1..50`).
- **Поведение:**
  - команда отправляет на CS-сервер RCON-триггер `ultrahc_ds_push_maps "rotation" "<request_id>"`;
  - список карт приходит в бот webhook-сообщением `type=maps_snapshot` и сопоставляется по `request_id`;
  - ответ приходит эпемерно, с явной пометкой источника (`CS server (active rotation)`);
  - при выходе за диапазон страниц бот возвращает ошибку с доступным диапазоном;
  - если snapshot не пришёл в пределах таймаута (`CS_MAPS_SNAPSHOT_TIMEOUT_SEC`, по умолчанию 6с), команда завершится ошибкой без fallback.
- **Пример:** `/server_maps page:2 per_page:20`

### `/server_maps_installed [page] [per_page]`
- **Назначение:** получить список установленных карт из папки `maps/` на игровом сервере.
- **Права:** `manage_messages`.
- **Параметры:**
  - `page` — номер страницы (по умолчанию `1`).
  - `per_page` — количество карт на странице (по умолчанию `20`, диапазон `1..50`).
- **Поведение:**
  - команда отправляет на CS-сервер RCON-триггер `ultrahc_ds_push_maps "installed" "<request_id>"`;
  - список карт приходит в бот webhook-сообщением `type=maps_snapshot` и сопоставляется по `request_id`;
  - список выводится эпемерно с источником `CS server (maps folder)`;
  - имена карт сортируются по алфавиту перед пагинацией;
  - если snapshot не пришёл в пределах таймаута (`CS_MAPS_SNAPSHOT_TIMEOUT_SEC`, по умолчанию 6с), команда завершится ошибкой без fallback.
- **Пример:** `/server_maps_installed per_page:30`

### `/map_change <map>`
- **Назначение:** изменяет текущую карту на игровом сервере.
- **Права:** `manage_messages`.
- **Параметры:**
  - `map` — имя карты. Доступно автодополнение активных карт.
- **Поведение:** бот отправляет команду смены карты и сообщает о запуске загрузки новой карты.
- **Пример:** `/map_change de_dust2`

### `/map_install <file> [map_name] [min_players] [max_players] [add_to_rotation] [priority]`
- **Назначение:** загружает карту/архив через Discord, раскладывает карту и ресурсы на сервер по FTP/FTPS и, при необходимости, добавляет карту в ротацию.
- **Права:** `manage_messages`.
- **Параметры:**
  - `file` — вложение `.bsp` или `.zip`.
  - `map_name` — необязательное название для сохранения без расширения.
  - `min_players` / `max_players` — параметры ротации (используются только при `add_to_rotation=true`).
  - `add_to_rotation` — `true/false`; при `true` бот пытается добавить карту в БД/Redis и перезагрузить map list на сервере.
  - `priority` — приоритет карты для ротации (по умолчанию `100`, меньше — выше).
- **Поведение:**
  - `.bsp` отправляется напрямую в `maps/`;
  - `.zip` поддерживает два формата: структурный (`maps/models/sound/sprites/gfx/overviews/resource`) и плоский (файлы в корне, раскладка по расширению);
  - архив должен содержать ровно один `.bsp`;
  - абсолютные пути и `..` в архиве блокируются;
  - конфликтующие файлы на FTP не перезаписываются: такие файлы пропускаются с предупреждением;
  - при ошибке во время загрузки уже отправленные файлы не откатываются (частичный результат сохраняется и возвращается в отчёте);
  - при `add_to_rotation=true` и отсутствии параметров ротации используются дефолты: `min_players=0`, `max_players=32`, `priority=100`;
  - добавление в ротацию выполняется только при **чистой установке**: без skipped/rejected и с успешной загрузкой `.bsp`; иначе шаг ротации пропускается с предупреждением;
  - если операция длится дольше лимита, команда автоматически переводится в фоновый режим и отправляет итог отдельным сообщением (в ответ на команду или в админ-канал).
- **Что важно учитывать:**
  - имя карты нормализуется (разрешены буквы/цифры/`_`/`-`);
  - для работы команды должны быть заполнены `MAP_FTP_*`, `MAP_DEPLOY_PROTOCOL` и `MAP_REMOTE_*` параметры в `config.py`;
  - значения `MAP_REMOTE_*` задаются абсолютными FTP-путями (например, `/cstrike/maps`).
- **Пример:** `/map_install file:de_mirage.zip add_to_rotation:true min_players:6 max_players:16 priority:50`

### `/map_add <map_name> [activated] [min_players] [max_players] [priority]`
- **Назначение:** создаёт запись о карте в базе данных.
- **Права:** `manage_messages`.
- **Параметры:**
  - `map_name` — обязательное название карты (без расширения).
  - `activated` — флаг активности (1 — в маппуле, 0 — отключена). По умолчанию `1`.
  - `min_players` / `max_players` — числовые ограничения для маппула. По умолчанию `0` и `32`.
  - `priority` — целое число; меньшие значения означают более высокий приоритет. По умолчанию `100`.
- **Пример:** `/map_add de_dust2 activated:1 min_players:4 max_players:16 priority:50`

### `/map_delete <map_name>`
- **Назначение:** удаляет карту из базы данных и маппула.
- **Права:** `manage_messages`.
- **Параметры:**
  - `map_name` — имя карты (поддерживается автодополнение всех карт).
- **Поведение:** запись удаляется из базы; бот подтверждает результат.
- **Пример:** `/map_delete de_dust2`

### `/map_update <map_name> [activated] [min_players] [max_players] [priority]`
- **Назначение:** обновляет параметры существующей карты.
- **Права:** `manage_messages`.
- **Параметры:**
  - `map_name` — идентификатор карты (автодополнение всех карт).
  - Остальные параметры необязательны; указывайте только те значения, которые нужно изменить.
- **Поведение:** бот обновляет указанные поля в базе данных и сообщает результат.
- **Пример:** `/map_update de_dust2 min_players:6 max_players:20`

## Дополнительные замечания

- Все команды, требующие прав `manage_messages`, должны вызываться из каналов, где у пользователя есть соответствующие разрешения.
- При возникновении ошибок бот возвращает подробное сообщение и пишет запись в журнал (`logger`).
- Если команда требует вложения (`/map_install`), Discord может отображать параметры в произвольном порядке; проверяйте, что указано нужное имя карты и пределы игроков.
- При добавлении новых команд или изменении логики необходимо обновлять:
  1. Этот справочник `docs/COMMANDS_REFERENCE_RU.md`;
  2. Текст команды `/help` (см. `bot/commands.py`);
  3. Общую документацию `docs/PROJECT_DOC_RU.md` при существенных изменениях функционала.
