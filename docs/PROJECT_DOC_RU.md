# Документация проекта Discord Bot for CS 1.6

## Обзор
Проект предоставляет инфраструктуру для Discord-бота, взаимодействующего с сервером Counter-Strike 1.6. Репозиторий содержит исходный код бота, вспомогательные сервисы, плагины и утилиты автоматизации, необходимые для интеграции игровых событий с Discord и сопутствующими веб-сервисами.

## Структура репозитория
- `app.py` — точка входа для запуска бота.
- `bot/` — основные модули Discord-бота.
- `config.py` — локальный файл конфигурации с токенами и параметрами подключения. При обновлении через `updater.sh` текущие значения сохраняются, а недостающие параметры автоматически добавляются из шаблона репозитория.
- `data_server/`, `cs_server/`, `observer/`, `logger/`, `rehlds/`, `webserver/` — вспомогательные сервисы и скрипты для взаимодействия с игровым сервером и веб-интерфейсом.
- `cs_server/map_installer.py` — обработчик команды `/map_install` (синхронный запуск с переводом в фон при таймауте).
- `cs_server/map_deploy_service.py` — сервис развёртывания карты (валидация вложения, FTP/FTPS upload, опциональная ротация, формирование результата).
- `amxmodx_plugin/` — плагин AMX Mod X для игрового сервера. Не переустанавливается скриптом обновления.
- `amxmodx_plugin/ultrahc_discord.sma` — содержит RCON-команду `ultrahc_ds_get_maps` для выдачи активной ротации и списка установленных карт с сервера.
- `requirements.txt` — зависимости Python.
- `docs/` — документация проекта.
- `PROJECT_LOG.md` — краткий журнал работ.
- `updater.sh`, `restore.sh` — утилиты обслуживания.

## Требования
- Python 3.10+ (рекомендуется использовать виртуальное окружение).
- Доступ к системе и сервису `systemd` для управления службой `discord_bot.service`.
- Установленные зависимости из `requirements.txt`.

## Настройка окружения
1. Склонируйте репозиторий на сервер.
2. Создайте и активируйте виртуальное окружение (при необходимости).
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
<!-- PAD:................................................................................................................................................................................................................ -->
4. Сконфигурируйте `config.py`, указав токены Discord, параметры подключения к базе данных, игровые адреса и ID администраторского канала для служебных уведомлений. Если планируется использовать `/map_install`, заполните также параметры `MAP_FTP_*`, `MAP_DEPLOY_PROTOCOL`, лимиты `MAP_INSTALL_*` и удалённые пути `MAP_REMOTE_*`.
5. Настройте единый сервис `systemd`, чтобы запускать бота через `app.py` или соответствующий скрипт.

## Обновление кода с помощью `updater.sh`
Скрипт автоматизирует остановку сервиса, создание резервной копии и скачивание свежей версии из GitHub без перезаписи существующих значений в `config.py` и без обновления плагина CS.

### Алгоритм работы
1. Остановка `discord_bot.service` через `systemctl` (по умолчанию используется `sudo`).
2. Создание новой папки резервной копии в `backups/<метка времени>` с копированием текущих файлов, исключая служебные директории (`venv`, `__pycache__`, `backups`, `.git`) и `config.py`.
3. Клонирование свежей версии репозитория во временную директорию.
4. Синхронизация новых файлов с рабочей директорией, исключая `config.py` и `amxmodx_plugin/`.
5. Слияние `config.py`: в локальный конфиг добавляются отсутствующие параметры из новой версии `config.py` (существующие значения не меняются).
6. Запуск сервиса `discord_bot.service`.

### Использование
```bash
chmod +x updater.sh
./updater.sh
./updater.sh --branch feature/status-push-webhook
```

Переменные окружения:
- `REPO_URL` — URL репозитория. Если не задан, скрипт попытается использовать `origin` из локального `.git`.
- `SERVICE_NAME` — имя сервиса `systemd` (по умолчанию `discord_bot.service`).
- `SUDO_BIN` — команда для запуска с привилегиями (`sudo` по умолчанию).
- `BACKUP_ROOT` — путь к каталогу резервных копий (по умолчанию `./backups`).
- `MERGE_CONFIG_DEFAULTS` — включить/выключить автодобавление новых параметров в `config.py` (`1` по умолчанию, `0` — отключить).

Аргументы запуска:
- `-b`, `--branch <имя_ветки>` — скачать и применить обновление из указанной ветки.

Примечание по совместимости:
- Для `updater.sh` и `restore.sh` в репозитории зафиксированы Unix-окончания строк (LF) через `.gitattributes`, чтобы исключить ошибку запуска `/usr/bin/env: 'bash\r'`.

## Восстановление состояния с помощью `restore.sh`
Скрипт возвращает файлы бота к состоянию из резервной копии.

### Особенности
- `config.py` не перезаписывается; существующие значения сохраняются.
- Новые параметры из шаблона `config.py` автоматически добавляет только `updater.sh` (если `MERGE_CONFIG_DEFAULTS != 0`).
- Используется последняя резервная копия, если явно не указан каталог.

### Использование
```bash
chmod +x restore.sh
./restore.sh                # восстановление из последней копии
./restore.sh 2024-05-19_1200 # восстановление из конкретной папки в backups/
```

Переменные окружения аналогичны `updater.sh` (`SERVICE_NAME`, `SUDO_BIN`, `BACKUP_ROOT`).

## Журнал и контроль изменений
- Все значимые работы фиксируются в `PROJECT_LOG.md`.
- При обновлении функционала обновляйте эту документацию и `README.md` согласно инструкциям в `AGENTS.md`.

## Логи

Логи пишутся в каталог `logs/`.

- Текущий лог-файл: `logs/log.txt` (всегда активный файл текущего дня).
- Ротация: ежедневно в полночь.
- Архивные файлы: `logs/log.txt.YYYY-MM-DD`.
- Хранение: 7 дней (старые файлы удаляются автоматически).

## Дополнительные рекомендации
- Регулярно проверяйте, что директория `backups/` достаточно свободна и старые копии можно архивировать или удалять.
- Тестируйте изменения на тестовом сервере перед запуском `updater.sh` на рабочем окружении.
- Храните секреты (`config.py`) вне системы контроля версий и создавайте отдельные резервные копии конфигурации.
- Если требуется отключить стартовые уведомления бота, оставьте `ADMIN_CHANNEL_ID = None` в `config.py`.
- При передаче параметров в RCON-команды двойные кавычки автоматически заменяются на одинарные, а обратные слэши дублируются.
  Поэтому сообщения `Привет "всем"` отобразятся в игре как `Привет 'всем'`, а пути вида `C:\cfg\autoexec.cfg` сохранятся полностью.
- Для `ultrahc_ds_send_msg` увеличен буфер входных аргументов в AMX-плагине (до 256 символов), поэтому сообщения из Discord больше не обрезаются на первых словах. Очень длинные реплики по-прежнему могут усекаться ограничением игрового чата.

## Обновление статуса CS-сервера

Статус в информационном канале обновляется по push-модели: AMX-плагин сам отправляет webhook `type=info` на `/webhook` при изменении состояния сервера и по периодическому heartbeat-таймеру.

Триггеры отправки `type=info`:
- подключение игрока;
- отключение игрока;
- события `DeathMsg` и `TeamInfo` (изменения счёта/команды);
- периодический heartbeat (по умолчанию раз в 30 секунд), чтобы статус не замирал даже при отсутствии игровых событий.

Постоянный RCON polling статуса (`ultrahc_ds_get_info` по таймеру из бота) отключён. RCON-соединение теперь используется для управляющих команд из Discord (`/connect_to_cs`, `/rcon`, модерация и т.д.), а статус-канал поддерживается webhook-потоком из CS.
### Безопасность webhook

- Доступ к `/webhook` ограничен списком `WEB_ALLOWED_IPS`.
- Дополнительно можно включить проверку API-ключа: задайте `API_KEY` в `config.py` и передавайте его в заголовке `Authorization` (или `X-Api-Key`).
- Если `API_KEY` пустой/не задан, проверка ключа отключена (остаётся только фильтрация по IP).

## Команда `/help`
Команда выводит список доступных slash-команд бота с краткими описаниями, разделёнными по категориям. Для подробного описания с примерами используйте [справочник `docs/COMMANDS_REFERENCE_RU.md`](https://github.com/F4ntik/discord_bot_for_cs/blob/main/docs/COMMANDS_REFERENCE_RU.md).

## Команды `/server_maps` и `/server_maps_installed`
Команды нужны, чтобы явно получать список карт именно с игрового сервера, без смешивания с данными БД бота.

- `/server_maps`:
  - источник — активная серверная ротация (`maps_ultrahc.ini` / map manager);
  - использует RCON-команду `ultrahc_ds_get_maps rotation`;
  - поддерживает пагинацию `page` и `per_page` (по умолчанию `1` и `20`).
- `/server_maps_installed`:
  - источник — фактические `.bsp` файлы в папке `maps/` на сервере;
  - использует RCON-команду `ultrahc_ds_get_maps installed`;
  - поддерживает ту же пагинацию `page` и `per_page`.
- Обе команды:
  - отвечают эпемерно;
  - показывают явный источник данных в ответе;
  - при выходе `page` за диапазон возвращают сообщение с допустимыми страницами.

## Команда `/map_install`
Команда предназначена для прод-установки карт через Discord: принимает `.bsp` или `.zip`, загружает карту и ресурсы на игровой сервер по FTP/FTPS и (опционально) добавляет карту в ротацию.

- **Параметры:**
  - `file` — вложение (`.bsp` или `.zip`).
  - `map_name` — необязательное имя карты без расширения.
  - `min_players` и `max_players` — параметры ротации (используются при `add_to_rotation=true`).
  - `add_to_rotation` — флаг добавления карты в ротацию (БД/Redis + reload map list).
  - `priority` — приоритет карты в ротации (по умолчанию `100`, меньше — выше).
- **Поведение ZIP:**
  - поддерживаются два формата архива:
    - структурный (`maps/`, `models/`, `sound/`, `sprites/`, `gfx/`, `overviews/`, `resource/`);
    - плоский (файлы в корне архива), где путь назначения определяется по расширению;
  - в архиве должен быть ровно один `.bsp`;
  - абсолютные пути и `..` запрещены;
  - для одинаковых целевых путей в архиве берётся первый файл, остальные отклоняются с предупреждением.
- **Загрузка на FTP/FTPS:**
  - файлы раскладываются по удалённым каталогам `MAP_REMOTE_*`;
  - если файл уже существует на сервере, он **не перезаписывается** и помечается как `skipped`;
  - при ошибке в середине процесса откат не выполняется: уже загруженные файлы остаются на сервере, в ответе возвращается отчёт о частичной загрузке.
- **Ротация (`add_to_rotation=true`):**
  - выполняется только при **чистой установке**: без `skipped`, без `rejected`, и с успешной загрузкой `.bsp`;
  - при нечистой установке шаг ротации пропускается с предупреждением.
- **Фоновый режим:**
  - если операция занимает больше `MAP_INSTALL_SYNC_TIMEOUT_SEC`, команда автоматически продолжает выполнение в фоне и присылает итог отдельным сообщением.
- **Необходимые настройки в `config.py`:**
  - подключение: `MAP_DEPLOY_PROTOCOL`, `MAP_FTP_HOST`, `MAP_FTP_PORT`, `MAP_FTP_USER`, `MAP_FTP_PASSWORD`, `MAP_FTP_TIMEOUT_SEC`, `MAP_FTP_PASSIVE`, `MAP_FTP_USE_TLS`;
  - удалённые каталоги: `MAP_REMOTE_MAPS_DIR`, `MAP_REMOTE_BASE_DIR`, `MAP_REMOTE_MODELS_DIR`, `MAP_REMOTE_SOUND_DIR`, `MAP_REMOTE_SPRITES_DIR`, `MAP_REMOTE_GFX_DIR`, `MAP_REMOTE_OVERVIEWS_DIR`, `MAP_REMOTE_RESOURCE_DIR` (абсолютные пути на стороне сервера);
  - лимиты/таймауты: `MAP_INSTALL_MAX_FILE_MB`, `MAP_INSTALL_SYNC_TIMEOUT_SEC`.
- **Значения по умолчанию для ротации:** если `add_to_rotation=true` и параметры не заданы, используются `min_players=0`, `max_players=32`, `priority=100`.
- **Доступ:** команда доступна только пользователям с правом `manage_messages`.
