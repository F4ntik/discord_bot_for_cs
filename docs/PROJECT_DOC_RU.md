# Документация проекта Discord Bot for CS 1.6

## Обзор
Проект предоставляет инфраструктуру для Discord-бота, взаимодействующего с сервером Counter-Strike 1.6. Репозиторий содержит исходный код бота, вспомогательные сервисы, плагины и утилиты автоматизации, необходимые для интеграции игровых событий с Discord и сопутствующими веб-сервисами.

## Структура репозитория
- `app.py` — точка входа для запуска бота.
- `bot/` — основные модули Discord-бота.
- `config.py` — локальный файл конфигурации с токенами и параметрами подключения. При обновлении через `updater.sh` текущие значения сохраняются, а недостающие параметры автоматически добавляются из шаблона репозитория.
- `data_server/`, `cs_server/`, `observer/`, `logger/`, `rehlds/`, `webserver/` — вспомогательные сервисы и скрипты для взаимодействия с игровым сервером и веб-интерфейсом.
- `cs_server/map_installer.py` — обработчик команды `/map_install` (синхронный запуск с переводом в фон при таймауте).
- `cs_server/map_deploy_service.py` — сервис развёртывания карты (валидация вложения, FTP/FTPS upload, опциональная ротация, формирование результата).
- `amxmodx_plugin/` — плагин AMX Mod X для игрового сервера. Не переустанавливается скриптом обновления.
- `amxmodx_plugin/ultrahc_discord.sma` — содержит RCON-команду `ultrahc_ds_get_maps` для выдачи активной ротации и списка установленных карт с сервера.
- `requirements.txt` — зависимости Python.
- `docs/` — документация проекта.
- `PROJECT_LOG.md` — краткий журнал работ.
- `updater.sh`, `restore.sh` — утилиты обслуживания.

## Требования
- Python 3.10+ (рекомендуется использовать виртуальное окружение).
- Доступ к системе и сервису `systemd` для управления службой `discord_bot.service`.
- Установленные зависимости из `requirements.txt`.

## Настройка окружения
1. Склонируйте репозиторий на сервер.
2. Создайте и активируйте виртуальное окружение (при необходимости).
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
<!-- PAD:................................................................................................................................................................................................................ -->
4. Сконфигурируйте `config.py`, указав токены Discord, параметры подключения к базе данных, игровые адреса и ID администраторского канала для служебных уведомлений. Если планируется использовать `/map_install`, заполните также параметры `MAP_FTP_*`, `MAP_DEPLOY_PROTOCOL`, лимиты `MAP_INSTALL_*` и удалённые пути `MAP_REMOTE_*`.
5. Настройте единый сервис `systemd`, чтобы запускать бота через `app.py` или соответствующий скрипт.

## Сборка AMX-плагина
- Укажите путь к компилятору AMX Mod X (Windows): `D:\cs\compilator_1_9_0`.
- Команда сборки (PowerShell): `& "D:\cs\compilator_1_9_0\amxxpc.exe" ultrahc_discord.sma -oultrahc_discord`.
- Исходный файл плагина: `amxmodx_plugin/ultrahc_discord.sma`.
- Для новых правок в `.sma` рекомендуется выполнять локальную сборку после каждого изменения.
- Проверяйте сборку вручную, чтобы свежий `.amxx` не попадал с синтаксическими ошибками.

## Обновление кода с помощью `updater.sh`
Скрипт автоматизирует остановку сервиса, создание резервной копии и скачивание свежей версии из GitHub без перезаписи существующих значений в `config.py` и без обновления плагина CS.

### Алгоритм работы
1. Остановка `discord_bot.service` через `systemctl` (по умолчанию используется `sudo`).
2. Создание новой папки резервной копии в `backups/<метка времени>` с копированием текущих файлов, исключая служебные директории (`venv`, `__pycache__`, `backups`, `.git`) и `config.py`.
3. Клонирование свежей версии репозитория во временную директорию.
4. Синхронизация новых файлов с рабочей директорией, исключая `config.py` и `amxmodx_plugin/`.
5. Слияние `config.py`: в локальный конфиг добавляются отсутствующие параметры из новой версии `config.py` (существующие значения не меняются).
6. Запуск сервиса `discord_bot.service`.

### Использование
```bash
chmod +x updater.sh
./updater.sh
./updater.sh --branch feature/status-push-webhook
```

Переменные окружения:
- `REPO_URL` — URL репозитория. Если не задан, скрипт попытается использовать `origin` из локального `.git`.
- `SERVICE_NAME` — имя сервиса `systemd` (по умолчанию `discord_bot.service`).
- `SUDO_BIN` — команда для запуска с привилегиями (`sudo` по умолчанию).
- `BACKUP_ROOT` — путь к каталогу резервных копий (по умолчанию `./backups`).
- `MERGE_CONFIG_DEFAULTS` — включить/выключить автодобавление новых параметров в `config.py` (`1` по умолчанию, `0` — отключить).

Аргументы запуска:
- `-b`, `--branch <имя_ветки>` — скачать и применить обновление из указанной ветки.

Примечание по совместимости:
- Для `updater.sh` и `restore.sh` в репозитории зафиксированы Unix-окончания строк (LF) через `.gitattributes`, чтобы исключить ошибку запуска `/usr/bin/env: 'bash\r'`.

## Восстановление состояния с помощью `restore.sh`
Скрипт возвращает файлы бота к состоянию из резервной копии.

### Особенности
- `config.py` не перезаписывается; существующие значения сохраняются.
- Новые параметры из шаблона `config.py` автоматически добавляет только `updater.sh` (если `MERGE_CONFIG_DEFAULTS != 0`).
- Используется последняя резервная копия, если явно не указан каталог.

### Использование
```bash
chmod +x restore.sh
./restore.sh                # восстановление из последней копии
./restore.sh 2024-05-19_1200 # восстановление из конкретной папки в backups/
```

Переменные окружения аналогичны `updater.sh` (`SERVICE_NAME`, `SUDO_BIN`, `BACKUP_ROOT`).

## Журнал и контроль изменений
- Все значимые работы фиксируются в `PROJECT_LOG.md`.
- При обновлении функционала обновляйте эту документацию и `README.md` согласно инструкциям в `AGENTS.md`.

## Логи

Логи пишутся в каталог `logs/`.

- Текущий лог-файл: `logs/log.txt` (всегда активный файл текущего дня).
- Ротация: ежедневно в полночь.
- Архивные файлы: `logs/log.txt.YYYY-MM-DD`.
- Хранение: 7 дней (старые файлы удаляются автоматически).

## Дополнительные рекомендации
- Регулярно проверяйте, что директория `backups/` достаточно свободна и старые копии можно архивировать или удалять.
- Тестируйте изменения на тестовом сервере перед запуском `updater.sh` на рабочем окружении.
- Храните секреты (`config.py`) вне системы контроля версий и создавайте отдельные резервные копии конфигурации.
- Если требуется отключить стартовые уведомления бота, оставьте `ADMIN_CHANNEL_ID = None` в `config.py`.
- При передаче параметров в RCON-команды двойные кавычки автоматически заменяются на одинарные, а обратные слэши дублируются.
  Поэтому сообщения `Привет "всем"` отобразятся в игре как `Привет 'всем'`, а пути вида `C:\cfg\autoexec.cfg` сохранятся полностью.
- Для `ultrahc_ds_send_msg` увеличен буфер входных аргументов в AMX-плагине (до 256 символов), поэтому сообщения из Discord больше не обрезаются на первых словах. Очень длинные реплики по-прежнему могут усекаться ограничением игрового чата.
  На стороне бота добавлено приведение Discord-сообщений к лимитам AMXX (`author/msg` и общий лимит `read_args`), чтобы payload всегда корректно парсился в `HookMsgFromDs`.

## Обновление статуса CS-сервера

Статус в информационном канале обновляется по push-модели: AMX-плагин сам отправляет webhook `type=info` на `/webhook` при изменении состояния сервера и по периодическому heartbeat-таймеру.

Триггеры отправки `type=info`:
- подключение игрока;
- отключение игрока;
- события `DeathMsg`, `TeamInfo`, `TeamScore`, `Round_Start` и бомбовые игровые события (`Got_The_Bomb`, `Dropped_The_Bomb`, `Spawned_With_The_Bomb`, `Planted_The_Bomb`);
- периодический heartbeat (по умолчанию раз в 30 секунд), чтобы статус не замирал даже при отсутствии игровых событий.
- при большом числе игроков payload автоматически ограничивается по размеру, чтобы JSON webhook оставался валидным.

В webhook `type=info` дополнительно передаются поля:
- `map_timeleft_sec` — остаток времени карты в секундах;
- `round_number` — текущий номер раунда;
- `score_t` и `score_ct` — счёт команд T/CT;
- `bomb_carrier_steam_id` — `steam_id` игрока, который несёт C4 (если есть).
- `bomb_carrier_slot` — слот игрока-носителя C4 (используется как приоритетный идентификатор, чтобы корректно отмечать бомбу у ботов).
- `planted_bomb_steam_id` — `steam_id` игрока, который установил C4 в текущем раунде.
- `planted_bomb_slot` — слот игрока, который установил C4 (приоритетный идентификатор для корректной работы с ботами).

Формат статуса в Discord теперь включает:
- строку `До конца карты: mm:ss` (формируется из `map_timeleft_sec`);
- строку `Номер раунда: N`;
- заголовки команд в виде `Terrorists(x):` и `Counter-Terrorists(y):`;
- зелёную пометку ` (bomb)` после K/D у игрока-носителя C4.
- зелёную пометку ` (planted bomb)` у игрока, который поставил C4; метка держится до конца раунда и имеет приоритет над ` (bomb)`.
- Для устойчивости слот плантера определяется по `userid` из лог-события `Planted_The_Bomb` (с маппингом через `find_player("k", userid)`), а также дублируется через forward `bomb_planted(planter)` при наличии CSX.
- На серверах с нестабильным `register_logevent` дополнительно используется fallback через `plugin_log` (по полному тексту log-line) для `Planted_The_Bomb` и других бомбовых событий.

Постоянный RCON polling статуса (`ultrahc_ds_get_info` по таймеру из бота) отключён. RCON-соединение теперь используется для управляющих команд из Discord (`/connect_to_cs`, `/rcon`, модерация и т.д.), а статус-канал поддерживается webhook-потоком из CS.
### Безопасность webhook

- Доступ к `/webhook` ограничен списком `WEB_ALLOWED_IPS`.
- Дополнительно можно включить проверку API-ключа: задайте `API_KEY` в `config.py` и передавайте его в заголовке `Authorization` (или `X-Api-Key`).
- Если `API_KEY` пустой/не задан, проверка ключа отключена (остаётся только фильтрация по IP).

## Команда `/help`
Команда выводит список доступных slash-команд бота с краткими описаниями, разделёнными по категориям. Для подробного описания с примерами используйте [справочник `docs/COMMANDS_REFERENCE_RU.md`](https://github.com/F4ntik/discord_bot_for_cs/blob/main/docs/COMMANDS_REFERENCE_RU.md).

## Команды `/server_maps` и `/server_maps_installed`
Команды нужны, чтобы явно получать список карт именно с игрового сервера, без смешивания с данными БД бота.

- `/server_maps`:
  - источник — активная серверная ротация (`maps_ultrahc.ini` / map manager);
  - использует RCON-команду `ultrahc_ds_get_maps rotation`;
  - поддерживает пагинацию `page` и `per_page` (по умолчанию `1` и `20`).
- `/server_maps_installed`:
  - источник — фактические `.bsp` файлы в папке `maps/` на сервере;
  - использует RCON-команду `ultrahc_ds_get_maps installed`;
  - поддерживает ту же пагинацию `page` и `per_page`.
- Обе команды:
  - отвечают эпемерно;
  - показывают явный источник данных в ответе;
  - при выходе `page` за диапазон возвращают сообщение с допустимыми страницами.

## Команда `/map_install`
Команда предназначена для прод-установки карт через Discord: принимает `.bsp` или `.zip`, загружает карту и ресурсы на игровой сервер по FTP/FTPS и (опционально) добавляет карту в ротацию.

- **Параметры:**
  - `file` — вложение (`.bsp` или `.zip`).
  - `map_name` — необязательное имя карты без расширения.
  - `min_players` и `max_players` — параметры ротации (используются при `add_to_rotation=true`).
  - `add_to_rotation` — флаг добавления карты в ротацию (БД/Redis + reload map list).
  - `priority` — приоритет карты в ротации (по умолчанию `100`, меньше — выше).
- **Поведение ZIP:**
  - поддерживаются два формата архива:
    - структурный (`maps/`, `models/`, `sound/`, `sprites/`, `gfx/`, `overviews/`, `resource/`);
    - плоский (файлы в корне архива), где путь назначения определяется по расширению;
  - в архиве должен быть ровно один `.bsp`;
  - абсолютные пути и `..` запрещены;
  - для одинаковых целевых путей в архиве берётся первый файл, остальные отклоняются с предупреждением.
- **Загрузка на FTP/FTPS:**
  - файлы раскладываются по удалённым каталогам `MAP_REMOTE_*`;
  - если файл уже существует на сервере, он **не перезаписывается** и помечается как `skipped`;
  - при ошибке в середине процесса откат не выполняется: уже загруженные файлы остаются на сервере, в ответе возвращается отчёт о частичной загрузке.
- **Ротация (`add_to_rotation=true`):**
  - выполняется только при **чистой установке**: без `skipped`, без `rejected`, и с успешной загрузкой `.bsp`;
  - при нечистой установке шаг ротации пропускается с предупреждением.
- **Фоновый режим:**
  - если операция занимает больше `MAP_INSTALL_SYNC_TIMEOUT_SEC`, команда автоматически продолжает выполнение в фоне и присылает итог отдельным сообщением.
- **Необходимые настройки в `config.py`:**
  - подключение: `MAP_DEPLOY_PROTOCOL`, `MAP_FTP_HOST`, `MAP_FTP_PORT`, `MAP_FTP_USER`, `MAP_FTP_PASSWORD`, `MAP_FTP_TIMEOUT_SEC`, `MAP_FTP_PASSIVE`, `MAP_FTP_USE_TLS`;
  - удалённые каталоги: `MAP_REMOTE_MAPS_DIR`, `MAP_REMOTE_BASE_DIR`, `MAP_REMOTE_MODELS_DIR`, `MAP_REMOTE_SOUND_DIR`, `MAP_REMOTE_SPRITES_DIR`, `MAP_REMOTE_GFX_DIR`, `MAP_REMOTE_OVERVIEWS_DIR`, `MAP_REMOTE_RESOURCE_DIR` (абсолютные пути на стороне сервера);
  - лимиты/таймауты: `MAP_INSTALL_MAX_FILE_MB`, `MAP_INSTALL_SYNC_TIMEOUT_SEC`.
- **Значения по умолчанию для ротации:** если `add_to_rotation=true` и параметры не заданы, используются `min_players=0`, `max_players=32`, `priority=100`.
- **Доступ:** команда доступна только пользователям с правом `manage_messages`.


## Устойчивость webhook type
- В обработчике `/webhook` поле `type` нормализуется перед маршрутизацией (`info`/`message`): обрезаются края строки, а также схлопываются пробелы и управляющие символы внутри значения.
- Это защищает status webhook от ложного `400 Bad Request`, если HTTP-клиент/плагин прислал `type` в «грязном» формате (например, `in\x00fo` или `mes\nsage`).
- Если после нормализации значение всё ещё не распознано, бот по-прежнему отвечает `Bad Request: unknown_type`.

## Валидация webhook payload
- Для `/webhook` добавлена проверка типа JSON-тела: бот ожидает объект, а не массив/скаляр.
- Если пришёл payload неподходящего типа, бот отвечает `400 Bad Request: bad_payload_type` (вместо `500 Internal Server Error`) и пишет диагностический лог с типом payload.
- В `handle_webhook` добавлен общий перехват исключений с логом `Webhook unhandled exception`, чтобы любые неожиданные ошибки были видны в логах с контекстом запроса.


## Резервный тип webhook (type_code)
- AMX-плагин дополнительно передаёт поле type_code (1=info, 2=message, 3=moment_vote) вместе со строковым type.
- Бот сначала пытается распознать type как строку, а если строка повреждена, использует type_code как fallback.
- Это снижает риск Bad Request: unknown_type при редких искажениях символов в HTTP payload.

## WOW moments (OMG)
- Добавлен новый webhook-тип `moment_vote` (резервный `type_code=3`) для фиксации игровых WOW-моментов.
- Поток событий:
  - игрок пишет в чат `omg`, `/omg` или `!omg`;
  - AMXX-плагин показывает меню с людьми онлайн (без HLTV/ботов);
  - после выбора плагин отправляет `moment_vote` на `/webhook`.
- В payload передаются:
  - карта, раунд, `map_timeleft_sec`, `map_elapsed_sec`, `event_unix`;
  - данные голосующего (`voter_*`);
  - данные выбранного игрока (`target_*`, включая K/D и team).
- Агрегация выполняется в боте (в памяти):
  - окно объединения: `WOW_MOMENT_WINDOW_SEC` (по умолчанию 30 сек);
  - ключ момента: выбранный игрок (steam_id, fallback slot);
  - один голос от одного игрока на один агрегированный момент.
- Публикация в Discord:
  - отдельный канал `MOMENTS_CHANNEL_ID`;
  - создаётся 1 пост на момент, при новых голосах пост редактируется (растут звёзды).
- Ссылка на демо:
  - приоритетно бот может читать текущую запись через HLTV RCON `status` (строка `Recording to ...`);
  - если HLTV RCON недоступен, используется FTP fallback: в `WOW_DEMO_FTP_DIR` ищется незакрытая `*.dem` (архивы `*.dem.zip` игнорируются);
  - при наличии нескольких незакрытых `*.dem` (переход карты + cron-архивация) выбирается самая свежая по таймстампу из имени демки (`DDMMYYHHMM`), чтобы брать текущую запись;
  - для карт с модовым суффиксом (`de_dust2_2x2`) бот нормализует имя карты до базового (`de_dust2`) при сверке с demo;
  - если карта события и карта в найденной demo не совпадают, бот не публикует ложную ссылку: делает ретраи до 35 секунд (шаг 5 сек), и только после этого отправляет пост без demo при необходимости;
  - после определения имени бот строит публичную ссылку MyArena `getzipdemo.php` по `MYARENA_HID` и `MYARENA_DEMO_BASE_HOST`;
  - если ни HLTV, ни FTP не дали имя demo, момент всё равно публикуется (без ссылки).
- Формат сообщения WOW в Discord:
  - русифицированный заголовок и подписи полей;
  - `Таймкод: ~MM:SS от старта карты` (по `map_elapsed_sec`, источник — `get_gametime()` в AMXX);
  - строка `Кто отметил` со списком голосовавших (до 10 имен, затем `и еще N`).
- Важно: `updater.sh` не обновляет `amxmodx_plugin/`, поэтому `.amxx` нужно выкладывать вручную.

### Новые параметры `config.py`
- Все WOW-параметры сейчас помечены в `config.py` как `[EXPERIMENTAL]`, чтобы их было проще найти после `updater.sh`.
- `MOMENTS_CHANNEL_ID` — ID Discord-канала для WOW-моментов (поддерживается текстовый канал и ветка форума/Thread).
- `WOW_MOMENT_WINDOW_SEC` — окно агрегации голосов (сек).
- `WOW_MOMENT_SESSION_IDLE_SEC` — сброс in-memory сессии после простоя.
- `HLTV_HOST`, `HLTV_PORT`, `HLTV_RCON_PASSWORD`, `HLTV_RCON_TIMEOUT_SEC` — подключение к HLTV RCON.
- `MYARENA_HID`, `MYARENA_DEMO_BASE_HOST` — построение публичной ссылки на демо.
- `WOW_DEMO_FTP_HOST`, `WOW_DEMO_FTP_PORT`, `WOW_DEMO_FTP_USER`, `WOW_DEMO_FTP_PASSWORD`, `WOW_DEMO_FTP_DIR` — FTP fallback для определения текущей `.dem`.
- `WOW_DEMO_PREFER_FTP` — если `True`, FTP проверяется раньше HLTV RCON.

### Переключение между веткой и `main` через `updater.sh`
1. Перейти на WOW-ветку: `./updater.sh --branch feature/wow-moments`.
2. Заполнить экспериментальные параметры (удобнее в локальном `.env` по шаблону `.env.example`).
3. Для отката запустить: `./updater.sh --branch main`.
4. Важно: `config.py` при обновлении не перезаписывается, `updater.sh` только добавляет отсутствующие ключи из шаблона.
5. Поэтому ранее заполненные `[EXPERIMENTAL]` ключи сохраняются и при возврате на `main` остаются в конфиге как неиспользуемые до следующего включения WOW-ветки.

## Версия релиза
- Добавлен файл VERSION в корне проекта.
- updater.sh после загрузки ветки показывает версию из VERSION и после синхронизации — установленную версию.
- При старте бот пишет в лог строку вида Ultra disBot vX.Y.Z.
- Формат версий бота и AMX-плагина: `A.B.C`.
- `B` (второе число) — версия совместимости связки `бот <-> плагин`.
- Совместимыми считаются версии с одинаковым `B`, например:
  - бот `0.4.1` и плагин `0.4.8`;
  - бот `0.4.3` и плагин `0.4.12`.
- Несовместимыми считаются версии с разным `B`, например:
  - бот `0.5.1` и плагин `0.4.12`.
- Правило инкремента:
  - `C` увеличивается при обычных доработках в рамках текущего протокола;
  - `B` увеличивается при изменениях протокола/контракта между ботом и плагином;
  - после повышения `B` необходимо обновлять обе стороны связки до одинакового значения `B`.

## Инцидент 2026-02-17 (статус/info и Discord->CS чат)
- Подробный технический разбор с хронологией, симптомами, всеми попытками, временными стабилизациями и пошаговым планом дальнейшей диагностики вынесен в отдельный документ:
  `docs/INCIDENT_2026-02-17_STATUS_CHAT_RU.md`.
- Документ использовать как стартовую точку после «обнуления» контекста: там зафиксировано, где проблема уже решена (бот/webhook), где остались риски (AMX info/chat при онлайне), и какой порядок безопасного возврата `info`.

## Секреты и `.env`
- Для локальных тестов можно хранить чувствительные параметры в корневом файле `.env`.
- Бот читает `.env` при старте и использует значения как fallback, если соответствующий параметр не задан в `config.py`.
- Рекомендуемый порядок:
  1. Заполнить `.env` по шаблону `.env.example`.
  2. Держать `.env` только локально (файл уже добавлен в `.gitignore`).
  3. Публиковать в репозиторий только `.env.example` с плейсхолдерами.
- Обязательные Discord-поля для запуска бота: `BOT_TOKEN`, `GUILD_ID`, `CS_CHAT_CHNL_ID`, `INFO_CHANNEL_ID`.
- Для WOW-ленты дополнительно задать `MOMENTS_CHANNEL_ID` (можно указать ID ветки форума/Thread).
- Параметры WOW/демок, которые удобно задавать через `.env`: `MYARENA_HID`, `MYARENA_DEMO_BASE_HOST`, `WOW_DEMO_FTP_*`, `WOW_DEMO_PREFER_FTP`, `HLTV_*`.
