# Документация проекта Discord Bot for CS 1.6

## Обзор
Проект предоставляет инфраструктуру для Discord-бота, взаимодействующего с сервером Counter-Strike 1.6. Репозиторий содержит исходный код бота, вспомогательные сервисы, плагины и утилиты автоматизации, необходимые для интеграции игровых событий с Discord и сопутствующими веб-сервисами.

## Структура репозитория
- `app.py` — точка входа для запуска бота.
- `bot/` — основные модули Discord-бота.
- `config.py` — локальный файл конфигурации с токенами и параметрами подключения. **Не обновляется автоматически**.
- `data_server/`, `cs_server/`, `observer/`, `logger/`, `rehlds/`, `webserver/` — вспомогательные сервисы и скрипты для взаимодействия с игровым сервером и веб-интерфейсом.
- `amxmodx_plugin/` — плагин AMX Mod X для игрового сервера. Не переустанавливается скриптом обновления.
- `requirements.txt` — зависимости Python.
- `docs/` — документация проекта.
- `PROJECT_LOG.md` — краткий журнал работ.
- `updater.sh`, `restore.sh` — утилиты обслуживания.

## Требования
- Python 3.10+ (рекомендуется использовать виртуальное окружение).
- Доступ к системе и сервису `systemd` для управления службой `discord_bot.service`.
- Установленные зависимости из `requirements.txt`.

## Настройка окружения
1. Склонируйте репозиторий на сервер.
2. Создайте и активируйте виртуальное окружение (при необходимости).
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
4. Сконфигурируйте `config.py`, указав токены Discord, параметры подключения к базе данных, игровые адреса и ID администраторского канала для служебных уведомлений.
5. Настройте единый сервис `systemd`, чтобы запускать бота через `app.py` или соответствующий скрипт.

## Обновление кода с помощью `updater.sh`
Скрипт автоматизирует остановку сервиса, создание резервной копии и скачивание свежей версии из GitHub без перезаписи `config.py` и плагина CS.

### Алгоритм работы
1. Остановка `discord_bot.service` через `systemctl` (по умолчанию используется `sudo`).
2. Создание новой папки резервной копии в `backups/<метка времени>` с копированием текущих файлов, исключая служебные директории (`venv`, `__pycache__`, `backups`, `.git`) и `config.py`.
3. Клонирование свежей версии репозитория во временную директорию.
4. Синхронизация новых файлов с рабочей директорией, исключая `config.py` и `amxmodx_plugin/`.
5. Запуск сервиса `discord_bot.service`.

### Использование
```bash
chmod +x updater.sh
./updater.sh
```

Переменные окружения:
- `REPO_URL` — URL репозитория. Если не задан, скрипт попытается использовать `origin` из локального `.git`.
- `SERVICE_NAME` — имя сервиса `systemd` (по умолчанию `discord_bot.service`).
- `SUDO_BIN` — команда для запуска с привилегиями (`sudo` по умолчанию).
- `BACKUP_ROOT` — путь к каталогу резервных копий (по умолчанию `./backups`).

## Восстановление состояния с помощью `restore.sh`
Скрипт возвращает файлы бота к состоянию из резервной копии.

### Особенности
- `config.py` не перезаписывается.
- Используется последняя резервная копия, если явно не указан каталог.

### Использование
```bash
chmod +x restore.sh
./restore.sh                # восстановление из последней копии
./restore.sh 2024-05-19_1200 # восстановление из конкретной папки в backups/
```

Переменные окружения аналогичны `updater.sh` (`SERVICE_NAME`, `SUDO_BIN`, `BACKUP_ROOT`).

## Журнал и контроль изменений
- Все значимые работы фиксируются в `PROJECT_LOG.md`.
- При обновлении функционала обновляйте эту документацию и `README.md` согласно инструкциям в `AGENTS.md`.

## Дополнительные рекомендации
- Регулярно проверяйте, что директория `backups/` достаточно свободна и старые копии можно архивировать или удалять.
- Тестируйте изменения на тестовом сервере перед запуском `updater.sh` на рабочем окружении.
- Храните секреты (`config.py`) вне системы контроля версий и создавайте отдельные резервные копии конфигурации.
- Если требуется отключить стартовые уведомления бота, оставьте `ADMIN_CHANNEL_ID = None` в `config.py`.
- При передаче параметров в RCON-команды кавычки и обратные слэши экранируются автоматически, поэтому допускаются строки вида
  `Привет "всем"` и пути `C:\cfg\autoexec.cfg`.

## Команда `/help`
Команда выводит список доступных slash-команд бота с краткими описаниями, разделёнными по категориям. Тестовые функции дополнительно помечаются как находящиеся в тестовом режиме. Для подробного описания с примерами используйте [справочник `docs/COMMANDS_REFERENCE_RU.md`](https://github.com/F4ntik/discord_bot_for_cs/blob/main/docs/COMMANDS_REFERENCE_RU.md).

## Команда `/map_install`
Команда предназначена для загрузки файлов карт напрямую через Discord и сохранения их в рабочей директории бота. **На данный момент это тестовый функционал.**

- **Параметры:**
  - `file` — вложение с картой (`.bsp` или `.zip`).
  - `map_name` — необязательное имя карты без расширения.
  - `min_players` и `max_players` — числовые параметры для конфигураций Map Manager Modular.
- **Результат выполнения:**
  - исходный файл сохраняется в каталоге `uploaded_maps/`.
  - создаётся текстовый файл `<map_name>.txt` с указанными параметрами, что подтверждает корректную обработку команды.
- **Доступ:** команда доступна только пользователям с правом `manage_messages`.
